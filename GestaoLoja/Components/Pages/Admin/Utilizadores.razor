@page "/admin/utilizadores"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

@attribute [Authorize(Roles = "Administrador, Funcionario")]

<PageTitle>Gestão de Utilizadores</PageTitle>

<h1>Gestão de Utilizadores</h1>

@if (Users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Email</th>
                <th>NIF</th>
                <th>Cargo Atual</th>
                <th>Mudar Cargo</th>
                <th>Estado</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Users)
            {
                <tr>
                    <td>@user.Email</td>
                    <td>
                        @if (!string.IsNullOrEmpty(user.Nif))
                        {
                            <span class="font-monospace">@user.Nif</span>
                        }
                        else
                        {
                            <span class="text-muted small">-</span>
                        }
                    </td>
                    <td>
                        <span class="badge bg-info text-dark">@user.TipoUtilizador</span>
                    </td>

                    <td>
                        @if (user.Email == CurrentUserEmail)
                        {
                            <span class="text-muted small">Eu</span>
                        }
                        else
                        {
                            <div class="btn-group btn-group-sm">
                                @if (SouAdmin)
                                {
                                    <button class="btn @(user.TipoUtilizador == "Funcionario" ? "btn-dark" : "btn-outline-dark")"
                                            @onclick='() => MudarCargo(user, "Funcionario")'>
                                        Func
                                    </button>
                                }

                                @if (SouAdmin || (SouFuncionario && (user.TipoUtilizador == "Cliente" || user.TipoUtilizador == "Fornecedor")))
                                {
                                    <button class="btn @(user.TipoUtilizador == "Fornecedor" ? "btn-primary" : "btn-outline-primary")"
                                            @onclick='() => MudarCargo(user, "Fornecedor")'>
                                        Forn
                                    </button>

                                    <button class="btn @(user.TipoUtilizador == "Cliente" ? "btn-secondary" : "btn-outline-secondary")"
                                            @onclick='() => MudarCargo(user, "Cliente")'>
                                        Cli
                                    </button>
                                }
                            </div>
                        }
                    </td>

                    <td>
                        @if (user.EstadoConta == "Ativo")
                        {
                            <span class="badge bg-success">Ativo</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">@user.EstadoConta</span>
                        }
                    </td>

                    <td>
                        @if (user.Email == CurrentUserEmail)
                        {
                            <span class="text-muted small fst-italic">A conta atual</span>
                        }
                        else
                        {
                            @if (SouAdmin || (SouFuncionario && (user.TipoUtilizador == "Cliente" || user.TipoUtilizador == "Fornecedor")))
                            {
                                @if (user.EstadoConta != "Ativo")
                                {
                                    <button class="btn btn-sm btn-success" @onclick='() => AlterarEstado(user, "Ativo")'>
                                        <i class="bi bi-check-lg"></i> Aprovar
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-warning" @onclick='() => AlterarEstado(user, "Pendente")'>
                                        <i class="bi bi-pause-fill"></i> Suspender
                                    </button>
                                }
                            }
                            else
                            {
                                <span class="text-muted small"><i class="bi bi-lock"></i> Bloqueado</span>
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<ApplicationUser>? Users;
    
    // Variáveis para controlar Permissões
    private string CurrentUserEmail = "";
    private bool SouAdmin = false;
    private bool SouFuncionario = false;

    protected override async Task OnInitializedAsync()
    {
        // 1. Descobrir quem sou eu e os meus poderes
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        CurrentUserEmail = userPrincipal.Identity?.Name ?? "";
        SouAdmin = userPrincipal.IsInRole("Administrador");
        SouFuncionario = userPrincipal.IsInRole("Funcionario");

        await CarregarUsers();
    }

    private async Task CarregarUsers()
    {
        using var context = DbFactory.CreateDbContext();
        Users = await context.Users.OrderBy(u => u.Email).ToListAsync();
    }

    private async Task AlterarEstado(ApplicationUser user, string novoEstado)
    {
        // Dupla verificação de segurança no servidor
        if (user.Email == CurrentUserEmail) return; // Nunca apagar a si próprio
        if (SouFuncionario && !SouAdmin && (user.TipoUtilizador == "Administrador" || user.TipoUtilizador == "Funcionario")) return; // Staff não toca em chefias

        using var context = DbFactory.CreateDbContext();
        var userNaBd = await context.Users.FindAsync(user.Id);
        
        if (userNaBd != null)
        {
            userNaBd.EstadoConta = novoEstado;
            await context.SaveChangesAsync();
            await CarregarUsers();
        }
    }

    private async Task MudarCargo(ApplicationUser user, string novoRole)
    {
        // Verificações de segurança
        if (user.Email == CurrentUserEmail) return;
        if (novoRole == "Funcionario" && !SouAdmin) return; // Só Admin cria Funcionários
        if (SouFuncionario && (user.TipoUtilizador == "Administrador" || user.TipoUtilizador == "Funcionario")) return; // Staff não mexe em Staff

        // Lógica do Identity
        var userReal = await UserManager.FindByIdAsync(user.Id);
        if (userReal != null)
        {
            // Remover cargos antigos
            var rolesAtuais = await UserManager.GetRolesAsync(userReal);
            await UserManager.RemoveFromRolesAsync(userReal, rolesAtuais);

            // Adicionar novo cargo
            await UserManager.AddToRoleAsync(userReal, novoRole);

            // Atualizar texto na BD (para a tabela e queries simples)
            userReal.TipoUtilizador = novoRole;
            await UserManager.UpdateAsync(userReal);

            await CarregarUsers();
        }
    }
}