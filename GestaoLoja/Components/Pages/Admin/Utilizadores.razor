@page "/admin/utilizadores"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using GestaoLoja.Entities
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

@attribute [Authorize(Roles = "Administrador, Funcionario")]

<PageTitle>Gestão de Utilizadores</PageTitle>

<h1>Gestão de Utilizadores</h1>

<div class="card mb-4 bg-light shadow-sm border-0">
    <div class="card-body p-3">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-secondary">Estado da Conta:</label>
                <select class="form-select" @bind="FiltroEstado">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendentes (Aguardam Aprovação)</option>
                    <option value="Ativo">Ativos</option>
                    <option value="Suspenso">Suspensos</option>
                </select>
            </div>

            <div class="col-md-2">
                <button class="btn btn-secondary w-100" @onclick="AtualizarComFiltro">
                    <i class="bi bi-filter"></i> Filtrar
                </button>
            </div>
        </div>
    </div>
</div>

@if (Users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-hover">
        <thead>
            <tr>
                @* <th>#ID</th> *@
                <th>Email</th>
                <th>NIF</th>
                <th>Cargo Atual</th>
                <th>Mudar Cargo</th>
                <th>Estado</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Users)
            {
                <tr>
                    @* <td class="fw-bold ps-3 text-secondary">@user.Id</td> *@
                    <td>@user.Email</td>
                    <td>
                        @if (!string.IsNullOrEmpty(user.Nif))
                        {
                            <span class="font-monospace">@user.Nif</span>
                        }
                        else
                        {
                            <span class="text-muted small">-</span>
                        }
                    </td>
                    <td>
                        <span class="badge bg-info text-dark">@user.TipoUtilizador</span>
                    </td>

                    <td>
                        @if (user.Email == CurrentUserEmail)
                        {
                            <span class="text-muted small">Eu</span>
                        }
                        else
                        {
                            <div class="btn-group btn-group-sm">
                                @if (SouAdmin)
                                {
                                    <button class="btn @(user.TipoUtilizador == "Funcionario" ? "btn-dark" : "btn-outline-dark")"
                                            @onclick='() => MudarCargo(user, "Funcionario")'>
                                        Func
                                    </button>
                                }

                                @if (SouAdmin || (SouFuncionario && (user.TipoUtilizador == "Cliente" || user.TipoUtilizador == "Fornecedor")))
                                {
                                    <button class="btn @(user.TipoUtilizador == "Fornecedor" ? "btn-primary" : "btn-outline-primary")"
                                            @onclick='() => MudarCargo(user, "Fornecedor")'>
                                        Forn
                                    </button>

                                    <button class="btn @(user.TipoUtilizador == "Cliente" ? "btn-secondary" : "btn-outline-secondary")"
                                            @onclick='() => MudarCargo(user, "Cliente")'>
                                        Cli
                                    </button>
                                }
                            </div>
                        }
                    </td>

                    <td>
                        @if (user.EstadoConta == "Ativo")
                        {
                            <span class="badge bg-success">Ativo</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">@user.EstadoConta</span>
                        }
                    </td>

                    <td>
                        @if (user.Email == CurrentUserEmail)
                        {
                            <span class="text-muted small fst-italic">A conta atual</span>
                        }
                        else
                        {
                            @if (SouAdmin || (SouFuncionario && (user.TipoUtilizador == "Cliente" || user.TipoUtilizador == "Fornecedor")))
                            {
                                @if (user.EstadoConta == "Pendente")
                                {
                                    <button class="btn btn-sm btn-success" @onclick='() => AlterarEstado(user, "Ativo")' title="Aprovar">
                                        <i class="bi bi-check-lg"></i> Aprovar
                                    </button>
                                }
                                else if (user.EstadoConta == "Ativo")
                                {
                                    <button class="btn btn-sm btn-warning" @onclick='() => AlterarEstado(user, "Suspenso")' title="Suspender">
                                        <i class="bi bi-pause-fill"></i> Suspender
                                    </button>
                                }
                                else if (user.EstadoConta == "Suspenso")
                                {
                                    <button class="btn btn-sm btn-outline-success" @onclick='() => AlterarEstado(user, "Ativo")' title="Reativar">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reativar
                                    </button>
                                }
                            }
                            else
                            {
                                <span class="text-muted small"><i class="bi bi-lock"></i> Bloqueado</span>
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-outline-primary" @onclick="PaginaAnterior" disabled="@(PaginaAtual == 1)">
            <i class="bi bi-chevron-left"></i> Anterior
        </button>
        <span>Página <strong>@PaginaAtual</strong> de <strong>@TotalPaginas</strong> (Total: @TotalItens)</span>
        <button class="btn btn-outline-primary" @onclick="PaginaProxima" disabled="@(PaginaAtual == TotalPaginas)">
            Próxima <i class="bi bi-chevron-right"></i>
        </button>
    </div>
}

@code {
    private List<ApplicationUser>? Users;

    private string FiltroEstado { get; set; } = "";

    // Variáveis para controlar Permissões
    private string CurrentUserEmail = "";
    private bool SouAdmin = false;
    private bool SouFuncionario = false;

    // Paginação
    private int PaginaAtual { get; set; } = 1;
    private int TamanhoPagina { get; set; } = 8;
    private int TotalItens { get; set; } = 0;
    private int TotalPaginas => (int)Math.Ceiling((double)TotalItens / TamanhoPagina);

    protected override async Task OnInitializedAsync()
    {
        // Descobrir quem sou eu e os meus poderes
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        CurrentUserEmail = userPrincipal.Identity?.Name ?? "";
        SouAdmin = userPrincipal.IsInRole("Administrador");
        SouFuncionario = userPrincipal.IsInRole("Funcionario");

        await CarregarUsers();
    }

    private async Task AtualizarComFiltro()
    {
        PaginaAtual = 1;
        await CarregarUsers();
    }

    private async Task CarregarUsers()
    {
        using var context = DbFactory.CreateDbContext();
        var query = context.Users.AsQueryable();

        if (!string.IsNullOrEmpty(FiltroEstado))
        {
            query = query.Where(u => u.EstadoConta == FiltroEstado);
        }

        TotalItens = await query.CountAsync();

        // Aplicar Paginação (Saltar X e Pegar Y)
        Users = await query
            .OrderBy(u => u.Email)
            .Skip((PaginaAtual - 1) * TamanhoPagina)
            .Take(TamanhoPagina)
            .ToListAsync();
    }

    private async Task AlterarEstado(ApplicationUser user, string novoEstado)
    {
        // Dupla verificação de segurança no servidor
        if (user.Email == CurrentUserEmail) return; // Nunca apagar a si próprio
        if (SouFuncionario && !SouAdmin && (user.TipoUtilizador == "Administrador" || user.TipoUtilizador == "Funcionario")) return; // Staff não toca em chefias

        using var context = DbFactory.CreateDbContext();
        var userNaBd = await context.Users.FindAsync(user.Id);
        
        if (userNaBd != null)
        {
            userNaBd.EstadoConta = novoEstado;
            await context.SaveChangesAsync();
            await CarregarUsers();
        }
    }

    private async Task MudarCargo(ApplicationUser user, string novoRole)
    {
        // Verificações de segurança
        if (user.Email == CurrentUserEmail) return;
        if (novoRole == "Funcionario" && !SouAdmin) return; // Só Admin cria Funcionários
        if (SouFuncionario && (user.TipoUtilizador == "Administrador" || user.TipoUtilizador == "Funcionario")) return; // Staff não mexe em Staff

        // Lógica do Identity
        var userReal = await UserManager.FindByIdAsync(user.Id);
        if (userReal != null)
        {
            // Remover cargos antigos
            var rolesAtuais = await UserManager.GetRolesAsync(userReal);
            await UserManager.RemoveFromRolesAsync(userReal, rolesAtuais);

            // Adicionar novo cargo
            await UserManager.AddToRoleAsync(userReal, novoRole);

            // Atualizar texto na BD (para a tabela e queries simples)
            userReal.TipoUtilizador = novoRole;
            await UserManager.UpdateAsync(userReal);

            await CarregarUsers();
        }
    }

    private async Task PaginaAnterior()
    {
        if (PaginaAtual > 1) { PaginaAtual--; await CarregarUsers(); }
    }

    private async Task PaginaProxima()
    {
        if (PaginaAtual < TotalPaginas) { PaginaAtual++; await CarregarUsers(); }
    }
}